<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Membros</title>
	<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
	<style>
		body { font-family: system-ui, sans-serif; padding: 16px; }
		.toolbar { display:flex; gap:8px; align-items:center; margin-bottom:12px }
		.input { padding: 8px; border:1px solid #cbd5e1; border-radius:6px; width: 100% }
		.input, select { box-sizing: border-box }
		.btn { padding: 8px 12px; border: 1px solid #334155; background: #334155; color: #fff; border-radius: 6px; cursor:pointer }
		.table { border-collapse: collapse; width:100% }
		.table th, .table td { border:1px solid #e2e8f0; padding:8px; font-size: 14px }
		.table th { background:#f1f5f9; cursor:pointer; user-select:none }
		.modal { position: fixed; inset:0; background: rgba(0,0,0,.5); display:none; align-items:center; justify-content:center }
		.modal-inner { background: #fff; border-radius:8px; padding: 20px; width: 95%; max-width: 1300px; max-height: 90vh; overflow: auto; overflow-x: hidden }
		.grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(320px,1fr)); align-items: stretch }
		.card { border:1px solid #e2e8f0; border-radius:8px }
		.card-body { padding: 12px }
		.form-grid { display:grid; column-gap: 24px; row-gap: 12px; grid-template-columns: repeat(auto-fit, minmax(380px,1fr)) }
		.label { font-weight:600 }
		.row { display:grid; gap:8px }
		/* abas */
		.tabs { display:flex; gap:8px; margin: 12px 0 }
		.tab { padding:8px 12px; border:1px solid #cbd5e1; background:#f8fafc; color:#0f172a; border-radius:6px; cursor:pointer }
		.tab.active { background:#334155; color:#fff; border-color:#334155 }
		/* paginação */
		.pager { display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px }
		.pager .btn { background:#64748b; border-color:#64748b }
		/* indicador de filtro ativo */
		.filter-badge { margin-left:6px; background:#334155; color:#fff; border-radius:999px; font-size:11px; padding:2px 6px; }
		/* perfil */
		.profile { margin-left:auto; position:relative }
		.profile-btn { display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid #cbd5e1; background:#fff; color:#0f172a; border-radius:999px; cursor:pointer }
		.avatar { width:28px; height:28px; border-radius:999px; background:#334155; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:600 }
		.dropdown { position:absolute; right:0; top:40px; background:#fff; border:1px solid #cbd5e1; border-radius:8px; min-width:260px; box-shadow:0 8px 24px rgba(0,0,0,.08); display:none; z-index:50 }
		.dropdown .item { padding:10px 12px; border-bottom:1px solid #e2e8f0 }
		.dropdown .item:last-child { border-bottom:none }
		.dropdown .name { font-weight:600; color:#0f172a }
		.dropdown .email { font-size:12px; color:#475569; word-break:break-all }
	</style>
</head>
<body>
	<div class="toolbar">
		<input id="q" class="input" placeholder="Buscar..." list="suggestions" oninput="onMainInput()" />
		<datalist id="suggestions"></datalist>
		<button class="btn" onclick="search()">Pesquisar</button>
		<button class="btn" onclick="clearAllFilters()" title="Limpar filtros">Limpar filtros</button>
		<div class="profile" id="profile">
			<button class="profile-btn" onclick="toggleProfile()">
				<div class="avatar" id="avatar">?</div>
				<span id="profileName" style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap">Usuário</span>
			</button>
			<div class="dropdown" id="profileMenu">
				<div class="item">
					<div class="name" id="menuName">Usuário</div>
					<div class="email" id="menuEmail">email@example.com</div>
				</div>
				<div class="item"><button class="btn" style="width:100%" onclick="doLogout()">Sair</button></div>
			</div>
		</div>
	</div>

	<div class="tabs">
		<button id="tabTable" class="tab active" onclick="showTab('table')">Tabela</button>
		<button id="tabCharts" class="tab" onclick="showTab('charts')">Gráficos</button>
	</div>

	<div id="panelTable" style="display:block">
		<table class="table" id="tbl"><thead><tr>
			<th data-label="Membro" onclick="openFilterModal('Membro')">Membro</th>
			<th data-label="Sexo" onclick="openFilterModal('Sexo')">Sexo</th>
			<th data-label="Concurso" onclick="openFilterModal('Concurso')">Concurso</th>
			<th data-label="Cargo efetivo" onclick="openFilterModal('Cargo efetivo')">Cargo efetivo</th>
			<th data-label="eMail pessoal" onclick="openFilterModal('eMail pessoal')">eMail pessoal</th>
			<th>Ações</th>
		</tr></thead><tbody></tbody></table>
		<div id="pager" class="pager"></div>
	</div>

	<div id="panelCharts" style="display:none">
		<div class="grid">
			<div class="card"><div class="card-body"><div style="display:flex;justify-content:space-between"><strong>Top 20 por Comarca</strong><button class="btn" onclick="loadChartComarca()">Atualizar</button></div><div id="chartComarca" style="width:100%;height:320px"></div></div></div>
			<div class="card"><div class="card-body"><div style="display:flex;justify-content:space-between"><strong>Top 10 por Cargo efetivo</strong><button class="btn" onclick="loadChartCargo()">Atualizar</button></div><div id="chartCargo" style="width:100%;height:320px"></div></div></div>
			<div class="card"><div class="card-body"><div style="display:flex;justify-content:space-between"><strong>Mapa por Comarca (MG)</strong><button class="btn" onclick="loadMap()">Atualizar</button></div><div id="chartMap" style="width:100%;height:420px"></div><div id="mapMsg" style="opacity:.8;font-size:12px"></div></div></div>
			<div class="card"><div class="card-body"><div style="display:flex;justify-content:space-between"><strong>Relacionamentos (Amigos no MP)</strong><button class="btn" onclick="loadGraph()">Atualizar</button></div><div id="chartGraph" style="width:100%;height:420px"></div><div id="graphMsg" style="opacity:.8;font-size:12px"></div></div></div>
		</div>
	</div>

	<div class="modal" id="modal">
		<div class="modal-inner">
			<div style="display:flex; justify-content:space-between; align-items:center"><strong id="modalTitle">Detalhes</strong>
				<div style="display:flex; gap:8px">
					<button class="btn" onclick="saveModal()" id="btnSave" style="display:none">Salvar</button>
					<button class="btn" onclick="closeModal()">Fechar</button>
				</div>
			</div>
			<div id="modalBody"></div>
		</div>
	</div>

	<div class="modal" id="filterModal">
		<div class="modal-inner">
			<div style="display:flex; justify-content:space-between; align-items:center">
				<strong id="filterTitle">Filtrar</strong>
				<div style="display:flex; gap:8px">
					<button class="btn" onclick="applyFilterModal()">Aplicar</button>
					<button class="btn" onclick="closeFilterModal()">Fechar</button>
				</div>
			</div>
			<div style="display:flex; gap:8px; margin:8px 0">
				<input id="filterSearch" class="input" placeholder="Buscar valor..." oninput="renderFilterOptions()" />
				<button class="btn" onclick="clearFilterCurrent()">Limpar filtro desta coluna</button>
			</div>
			<div id="filterOptions" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:8px"></div>
		</div>
	</div>

	<script>
	function guard(){ if(!localStorage.getItem('token')) location.href='/login' }
	function token(){ return localStorage.getItem('token') || '' }
	function auth(){ return token() ? { 'Authorization': 'Bearer '+token() } : {} }
	function decodeJwtPayload(){ try{ const t=token(); if(!t) return {}; const p=t.split('.')[1]; const pad=(s)=>s.padEnd(s.length+((4-(s.length%4))%4),'='); return JSON.parse(atob(p.replace(/-/g,'+').replace(/_/g,'/')));}catch{return{}} }
	function isAdmin(){ const p=decodeJwtPayload(); const role=(p.role||((p.sub||{}).role)||'').toLowerCase(); return role==='admin' }

	let currentId = null; let currentData = null; let currentUser = null;
	const fields = [
		'Membro','Sexo','Concurso','Cargo efetivo','Titularidade','eMail pessoal','Cargo Especial','Telefone Unidade','Telefone celular','Unidade Lotação','Comarca Lotação','Time de futebol e outros grupos extraprofissionais','Quantidade de filhos','Nome dos filhos','Estado de origem','Acadêmico','Pretensão de movimentação na carreira','Carreira anterior','Liderança','Grupos identitários'
	]
	let perPage = 30, currentPage = 1, totalCount = 0, chartsLoaded = false
	let columnFilters = {} // { label: [values] }
	let filterCurrentLabel = null; let filterAllValues = []; let filterSelectedSet = new Set()

	function filtersParam(){ try{ return encodeURIComponent(JSON.stringify(columnFilters||{})) }catch{ return '' } }

	function renderHeaderFilters(){
		const ths = document.querySelectorAll('#tbl thead th[data-label]')
		ths.forEach(th=>{
			const label = th.getAttribute('data-label')
			const active = !!(columnFilters[label] && columnFilters[label].length)
			th.innerHTML = `${label}${active ? ' <span class="filter-badge">filtrado</span>' : ''}`
		})
	}

	function toggleProfile(){ const m=document.getElementById('profileMenu'); m.style.display = (m.style.display==='block'?'none':'block') }
	document.addEventListener('click', (e)=>{ const p=document.getElementById('profile'); if(!p.contains(e.target)) document.getElementById('profileMenu').style.display='none' })
	function renderProfile(){ const n=(currentUser?.name||'').trim(); const em=(currentUser?.email||'').trim(); const ini=(n?n[0]: (em?em[0]:'?')).toUpperCase(); document.getElementById('avatar').textContent=ini; document.getElementById('profileName').textContent=n||em||'Usuário'; document.getElementById('menuName').textContent=n||'Usuário'; document.getElementById('menuEmail').textContent=em||'' }
	async function loadMe(){ try{ const r=await fetch('/api/auth/me', { headers:{ ...auth() } }); const d=await r.json(); currentUser = d?.user||null; renderProfile() }catch{} }
	function doLogout(){ localStorage.removeItem('token'); location.href='/login' }

	function show(rows){
		const tbody = document.querySelector('#tbl tbody');
		tbody.innerHTML = ''
		for(const r of rows){
			const tr = document.createElement('tr')
			tr.innerHTML = `<td>${r.data['Membro']||''}</td><td>${r.data['Sexo']||''}</td><td>${r.data['Concurso']||''}</td><td>${r.data['Cargo efetivo']||''}</td><td>${r.data['eMail pessoal']||''}</td><td><button class='btn' onclick='openModal(${r.id})'>Ver</button></td>`
			tbody.appendChild(tr)
		}
	}
	async function search(page=1){
		guard(); currentPage = page
		const q = document.getElementById('q').value
		const r = await fetch(`/api/membros?page=${page}&per_page=${perPage}&q=${encodeURIComponent(q)}&filters_json=${filtersParam()}`, { headers: { 'Content-Type':'application/json', ...auth() } })
		if(r.status===401||r.status===422){ localStorage.removeItem('token'); location.href='/login'; return }
		const data = await r.json()
		show(data.data || [])
		totalCount = Number(data.total||0)
		renderPager(); renderHeaderFilters()
	}
	function renderPager(){
		const el = document.getElementById('pager')
		const totalPages = Math.max(1, Math.ceil(totalCount / perPage))
		const canPrev = currentPage > 1
		const canNext = currentPage < totalPages
		el.innerHTML = `
			<div style='margin-right:auto'>Total: ${totalCount} registros ${Object.keys(columnFilters).length? '(com filtros)':''}</div>
			<button class='btn' ${canPrev?'':'disabled'} onclick='gotoPage(${currentPage-1})'>Anterior</button>
			<span>Página ${currentPage} de ${totalPages}</span>
			<button class='btn' ${canNext?'':'disabled'} onclick='gotoPage(${currentPage+1})'>Próxima</button>
		`
	}
	function gotoPage(p){ if(p<1) return; search(p) }

	async function openModal(id){
		guard(); currentId = id; currentData = null
		document.getElementById('modalTitle').textContent = `Detalhes #${id}`
		document.getElementById('modalBody').innerHTML = 'Carregando...'
		document.getElementById('btnSave').style.display = isAdmin() ? 'inline-block' : 'none'
		document.getElementById('modal').style.display='flex'
		try{
			const r = await fetch(`/api/membros/${id}`, { headers: { 'Content-Type':'application/json', ...auth() } })
			if(r.status===401){ localStorage.removeItem('token'); location.href='/login'; return }
			if(!r.ok){ document.getElementById('modalBody').textContent = 'Falha ao carregar detalhes'; return }
			const row = await r.json(); currentData = (row && (row.data||row)) || {}
		}catch(e){ document.getElementById('modalBody').textContent = 'Erro ao carregar detalhes'; return }
		renderModal()
	}
	function renderModal(){
		const admin = isAdmin();
		let html = `<div class='form-grid'>`
		for(const k of fields){
			const v = currentData[k] ?? ''
			html += `<div class='row'><label class='label'>${k}</label>`
			if(admin){
				if(k==='Sexo') html += `<select class='input' data-key='${k}'><option value=''></option><option ${v==='Masculino'?'selected':''}>Masculino</option><option ${v==='Feminino'?'selected':''}>Feminino</option></select>`
				else if(k==='Estado de origem'){
					const ufs=['AC','AL','AP','AM','BA','CE','DF','ES','GO','MA','MT','MS','MG','PA','PB','PR','PE','PI','RJ','RN','RS','RO','RR','SC','SP','SE','TO']
					html += `<select class='input' data-key='${k}'><option value=''></option>${ufs.map(uf=>`<option ${v===uf?'selected':''}>${uf}</option>`).join('')}</select>`
				} else if(k==='Quantidade de filhos') html += `<input class='input' data-key='${k}' type='number' min='0' value='${v||''}' />`
				else html += `<input class='input' data-key='${k}' value='${String(v).replace(/"/g,'&quot;')}' />`
			} else {
				html += `<div>${v||'-'}</div>`
			}
			html += `</div>`
		}
		html += `</div>`
		document.getElementById('modalBody').innerHTML = html
	}
	async function saveModal(){
		const inputs = document.querySelectorAll('#modalBody [data-key]')
		const payload = { }
		for(const el of inputs){ payload[el.getAttribute('data-key')] = el.value }
		const r = await fetch(`/api/membros/${currentId}`, { method:'PUT', headers: { 'Content-Type':'application/json', ...auth() }, body: JSON.stringify({ data: payload }) })
		if(!r.ok){ alert('Falha ao salvar'); return }
		alert('Salvo com sucesso'); closeModal(); search(currentPage)
	}
	function closeModal(){ document.getElementById('modal').style.display='none' }

	function showTab(which){
		const tBtn = document.getElementById('tabTable'), cBtn = document.getElementById('tabCharts')
		const tPanel = document.getElementById('panelTable'), cPanel = document.getElementById('panelCharts')
		if(which==='charts'){
			tBtn.classList.remove('active'); cBtn.classList.add('active'); tPanel.style.display='none'; cPanel.style.display='block';
			loadChartsIfNeeded()
		}else{
			tBtn.classList.add('active'); cBtn.classList.remove('active'); tPanel.style.display='block'; cPanel.style.display='none';
		}
	}
	function loadChartsIfNeeded(){ if(chartsLoaded) return; loadChartComarca(); loadChartCargo(); loadMap(); loadGraph(); chartsLoaded=true }

	// Autocomplete + busca em tempo real
	let suggestTimer = null, searchTimer = null
	function onMainInput(){ debouncedSuggest(); debouncedSearch() }
	function debouncedSuggest(){ clearTimeout(suggestTimer); suggestTimer = setTimeout(suggest, 200) }
	function debouncedSearch(){ clearTimeout(searchTimer); searchTimer = setTimeout(()=>search(1), 200) }
	async function suggest(){
		const q = document.getElementById('q').value.trim(); if(!q) { document.getElementById('suggestions').innerHTML=''; return }
		const r = await fetch(`/api/membros/suggest?q=${encodeURIComponent(q)}`, { headers: { ...auth() } })
		if(!r.ok) return; const data = await r.json(); const list = document.getElementById('suggestions');
		list.innerHTML = (data.values||[]).map(v=>`<option value="${String(v).replace(/"/g,'&quot;')}"></option>`).join('')
	}

	// Filtro por coluna (modal) com aplicação em tempo real
	async function openFilterModal(label){
		filterCurrentLabel = label; filterSelectedSet = new Set(columnFilters[label]||[])
		document.getElementById('filterTitle').textContent = `Filtrar: ${label}`
		document.getElementById('filterSearch').value=''
		const r = await fetch(`/api/membros/distinct?field=${encodeURIComponent(label)}&limit=500&filters_json=${filtersParam()}`, { headers: { ...auth() } })
		const data = await r.json(); filterAllValues = data.values||[]
		renderFilterOptions()
		document.getElementById('filterModal').style.display='flex'
	}
	function renderFilterOptions(){
		const q = document.getElementById('filterSearch').value.trim().toLowerCase()
		const box = document.getElementById('filterOptions'); box.innerHTML=''
		const vals = filterAllValues.filter(v=> String(v||'').toLowerCase().includes(q))
		for(const v of vals){
			const id = `opt_${filterCurrentLabel}_${btoa(unescape(encodeURIComponent(String(v))))}`
			const div = document.createElement('div')
			div.innerHTML = `<label style='display:flex; gap:8px; align-items:center'><input type='checkbox' id='${id}' ${filterSelectedSet.has(String(v))?'checked':''} onchange='toggleFilterValue("${String(v).replace(/"/g,'&quot;')}")' /> <span>${String(v)||'(vazio)'}</span></label>`
			box.appendChild(div)
		}
	}
	function toggleFilterValue(val){
		val=String(val); if(filterSelectedSet.has(val)) filterSelectedSet.delete(val); else filterSelectedSet.add(val)
		const arr = Array.from(filterSelectedSet)
		if(arr.length) columnFilters[filterCurrentLabel]=arr; else delete columnFilters[filterCurrentLabel]
		renderHeaderFilters(); debouncedSearch()
	}
	function applyFilterModal(){ closeFilterModal() }
	function clearFilterCurrent(){ delete columnFilters[filterCurrentLabel]; filterSelectedSet = new Set(); renderFilterOptions(); renderHeaderFilters(); debouncedSearch() }
	function closeFilterModal(){ document.getElementById('filterModal').style.display='none' }
	function clearAllFilters(){ columnFilters = {}; renderHeaderFilters(); debouncedSearch() }

	async function loadChartComarca(){
		guard()
		const q = document.getElementById('q').value
		const r = await fetch(`/api/membros/aggregate?field=${encodeURIComponent('Comarca Lotação')}&limit=20&q=${encodeURIComponent(q)}&filters_json=${filtersParam()}`, { headers: { ...auth() } })
		const data = await r.json()
		const el = document.getElementById('chartComarca')
		const chart = echarts.init(el)
		const labels = (data.data||[]).map(x=>x.v)
		const values = (data.data||[]).map(x=>x.c)
		chart.setOption({ tooltip:{}, grid:{ left:8,right:8,top:24,bottom:8,containLabel:true }, xAxis:{ type:'value' }, yAxis:{ type:'category', data:labels, axisLabel:{ interval:0 } }, series:[{ type:'bar', data:values, itemStyle:{ color:'#2563eb' } }] })
	}
	async function loadChartCargo(){
		guard()
		const q = document.getElementById('q').value
		const r = await fetch(`/api/membros/aggregate?field=${encodeURIComponent('Cargo efetivo')}&limit=10&q=${encodeURIComponent(q)}&filters_json=${filtersParam()}`, { headers: { ...auth() } })
		const data = await r.json()
		const el = document.getElementById('chartCargo')
		const chart = echarts.init(el)
		const labels = (data.data||[]).map(x=>x.v)
		const values = (data.data||[]).map(x=>x.c)
		chart.setOption({ tooltip:{}, grid:{ left:8,right:8,top:24,bottom:8,containLabel:true }, xAxis:{ type:'category', data:labels, axisLabel:{ interval:0, rotate:20 } }, yAxis:{ type:'value' }, series:[{ type:'bar', data:values, itemStyle:{ color:'#16a34a' } }] })
	}

	let mgGeoLoaded=false, mgGeoFeatures=[]
	async function ensureMG(){ if(mgGeoLoaded) return; try{ const resp=await fetch('https://servicodados.ibge.gov.br/api/v3/malhas/municipios/31?formato=application/vnd.geo+json'); if(resp.ok){ const geo=await resp.json(); if(geo&&Array.isArray(geo.features)&&geo.features.length){ echarts.registerMap('mg_municipios', geo); mgGeoLoaded=true; mgGeoFeatures=geo.features; } } } catch(e) { mgGeoLoaded=false }
	}
	async function loadMap(){
		await ensureMG()
		const el = document.getElementById('chartMap')
		const chart = echarts.init(el)
		const q = document.getElementById('q').value
		const r = await fetch(`/api/membros/aggregate?field=${encodeURIComponent('Comarca Lotação')}&limit=9999&q=${encodeURIComponent(q)}&filters_json=${filtersParam()}`, { headers: { ...auth() } })
		const data = await r.json()
		const entries = {}; for(const it of (data.data||[])) entries[String(it.v||'').toUpperCase()] = it.c
		const seriesData = []
		for(const f of (mgGeoFeatures||[])){
			const name = (f.properties?.name||'').toUpperCase(); const label=f.properties?.name
			seriesData.push({ name: label, value: entries[name]||0 })
		}
		chart.setOption({ tooltip:{ trigger:'item', formatter:(p)=>`${p.name}: ${p.value??0}` }, visualMap:{ min:0, max: Math.max(1,...seriesData.map(d=>d.value||0)), left:'left', top:'bottom', text:['Alto','Baixo'], calculable:true }, series:[{ type:'map', map:'mg_municipios', roam:true, data:seriesData }] })
		document.getElementById('mapMsg').textContent = mgGeoLoaded? '' : 'Não foi possível carregar o mapa do IBGE agora.'
	}

	async function loadGraph(){
		const el = document.getElementById('chartGraph')
		const chart = echarts.init(el)
		let page=1; const per=500; const maxPages=20; const all=[]
		try{
			while(page<=maxPages){
				const r = await fetch(`/api/membros?page=${page}&per_page=${per}&filters_json=${filtersParam()}`, { headers: { ...auth() } })
				if(!r.ok) break; const data=await r.json(); const rows=data.data||[]; all.push(...rows); if(rows.length<per) break; page++
			}
		}catch{}
		if(!all.length){ chart.setOption({ series:[{ type:'graph', data:[], links:[] }] }); document.getElementById('graphMsg').textContent='Sem dados.'; return }
		const idToName={}, nameToId={}
		for(const r of all){ const nm=String(r.data['Membro']||r.data['Nome']||('#'+r.id)); idToName[r.id]=nm; const key=nm.normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().toUpperCase(); if(key&&!nameToId[key]) nameToId[key]=r.id }
		const edgeSet=new Set(); const degree={}; const idSet=new Set(all.map(r=>r.id))
		for(const r of all){ const raw=r.data['Amigos no MP (IDs)']; let friendIds=[]; if(Array.isArray(raw)) friendIds=raw.map(x=>Number(x)).filter(n=>Number.isFinite(n)); else if(typeof raw==='string'){ const ids=raw.split(/[^0-9]+/).map(s=>Number(s)).filter(n=>Number.isFinite(n)); if(ids.length) friendIds=ids }
			for(const fid of friendIds){ if(!idSet.has(fid)) continue; const a=Math.min(r.id,fid), b=Math.max(r.id,fid); const key=`${a}-${b}`; if(!edgeSet.has(key)&&a!==b){ edgeSet.add(key); degree[a]=(degree[a]||0)+1; degree[b]=(degree[b]||0)+1 } }
		}
		let nodesAll = Array.from(new Set(Array.from(edgeSet).flatMap(k=>k.split('-').map(s=>Number(s))))).map(id=>({ id:String(id), name:idToName[id]||('#'+id), value: degree[id]||1 }))
		if(!nodesAll.length){ chart.setOption({ series:[{ type:'graph', data:[], links:[] }] }); document.getElementById('graphMsg').textContent='Sem relacionamentos.'; return }
		const links = Array.from(edgeSet).map(k=>{ const [a,b]=k.split('-').map(s=>String(s)); return { source:a, target:b } })
		const nodes = nodesAll.map(n=>({ ...n, symbolSize: Math.max(8, 8+(n.value||0)*2) }))
		chart.setOption({ tooltip:{ formatter:(p)=>p.data?.name||'' }, series:[{ type:'graph', layout:'force', roam:true, label:{ show:true, position:'right', formatter:'{b}', fontSize:10 }, data:nodes, links, force:{ repulsion:120, edgeLength:[30,120] }, lineStyle:{ color:'#94a3b8' }, itemStyle:{ color:'#2563eb' } }] })
		document.getElementById('graphMsg').textContent=''
	}

	renderHeaderFilters(); showTab('table'); loadMe(); search(1)
	</script>
</body>
</html> 